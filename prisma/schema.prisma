generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String           @id @default(uuid())
  email                String           @unique
  passwordHash         String?          @map("password_hash")
  name                 String?
  role                 UserRole         @default(member)
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  avatar               String?
  bio                  String?
  designation          String?
  commentNotifications Boolean          @default(true)
  dailyDigest          Boolean          @default(false)
  emailNotifications   Boolean          @default(true)
  sprintNotifications  Boolean          @default(true)
  taskNotifications    Boolean          @default(true)
  theme                String           @default("system")
  viewDensity          String           @default("comfortable")
  githubAccessToken    String?          @map("github_access_token")
  githubId             String?          @unique @map("github_id")
  githubRefreshToken   String?          @map("github_refresh_token")
  githubTokenExpiry    DateTime?        @map("github_token_expiry")
  githubUsername       String?          @map("github_username")
  projectMemberships   ProjectMember[]
  createdProjects      Project[]
  linkedProjects       Project[]        @relation("GitHubLinkedBy")
  createdSprints       Sprint[]
  uploadedAttachments  TaskAttachment[]
  comments             TaskComment[]
  assignedTasks        Task[]           @relation("TaskAssignee")
  createdTasks         Task[]           @relation("TaskCreator")
  verticals            VerticalUser[]

  @@index([role])
  @@map("users")
}

model Vertical {
  id        String         @id @default(uuid())
  name      String         @unique
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  projects  Project[]
  users     VerticalUser[]

  @@map("verticals")
}

model VerticalUser {
  id         String   @id @default(uuid())
  verticalId String   @map("vertical_id")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vertical   Vertical @relation(fields: [verticalId], references: [id], onDelete: Cascade)

  @@unique([verticalId, userId])
  @@index([userId])
  @@index([verticalId])
  @@map("vertical_users")
}

model Project {
  id              String          @id @default(uuid())
  name            String
  description     String?
  verticalId      String          @map("vertical_id")
  createdBy       String          @map("created_by")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  githubLinkedAt  DateTime?       @map("github_linked_at")
  githubLinkedBy  String?         @map("github_linked_by")
  githubRepoId    BigInt?         @map("github_repo_id")
  githubRepoName  String?         @map("github_repo_name")
  githubRepoOwner String?         @map("github_repo_owner")
  syncLogs        GitHubSyncLog[]
  members         ProjectMember[]
  creator         User            @relation(fields: [createdBy], references: [id])
  linkedByUser    User?           @relation("GitHubLinkedBy", fields: [githubLinkedBy], references: [id])
  vertical        Vertical        @relation(fields: [verticalId], references: [id], onDelete: Cascade)
  sprints         Sprint[]

  @@index([verticalId])
  @@index([createdBy])
  @@index([createdAt(sort: Desc)])
  @@index([verticalId, createdAt(sort: Desc)])
  @@index([githubRepoOwner, githubRepoName])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
  @@index([projectId])
  @@map("project_members")
}

model Sprint {
  id        String       @id @default(uuid())
  projectId String       @map("project_id")
  name      String
  startDate DateTime     @map("start_date")
  endDate   DateTime     @map("end_date")
  status      SprintStatus @default(planned)
  completedAt DateTime?    @map("completed_at")
  createdBy   String       @map("created_by")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  creator   User         @relation(fields: [createdBy], references: [id])
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([projectId, status])
  @@map("sprints")
}

model Task {
  id                String           @id @default(uuid())
  sprintId          String           @map("sprint_id")
  title             String
  description       String?
  type              TaskType         @default(task)
  status            TaskStatus       @default(todo)
  priority          TaskPriority     @default(medium)
  storyPoints       Int?             @map("story_points")
  assigneeId        String?          @map("assignee_id")
  createdBy         String           @map("created_by")
  parentTaskId      String?          @map("parent_task_id")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  githubIssueId     BigInt?          @unique @map("github_issue_id")
  githubIssueNumber Int?             @map("github_issue_number")
  githubSyncedAt    DateTime?        @map("github_synced_at")
  githubUrl         String?          @map("github_url")
  githubStatus      String?          @map("github_status") // "open" | "closed" - tracks GitHub-side status
  requiredRole      String?          @map("required_role")
  labels            String[]         @default([])
  syncLogs          GitHubSyncLog[]
  attachments       TaskAttachment[]
  comments          TaskComment[]
  assignee          User?            @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator           User             @relation("TaskCreator", fields: [createdBy], references: [id])
  parentTask        Task?            @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: SetNull)
  childTasks        Task[]           @relation("TaskHierarchy")
  sprint            Sprint           @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  @@index([sprintId, status])
  @@index([assigneeId])
  @@index([parentTaskId])
  @@index([createdBy])
  @@index([createdAt(sort: Desc)])
  @@index([sprintId, createdAt(sort: Desc)])
  @@index([githubIssueId])
  @@index([sprintId, githubIssueNumber])
  @@index([sprintId, requiredRole])
  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([taskId, createdAt])
  @@index([userId])
  @@map("task_comments")
}

model TaskAttachment {
  id         String   @id @default(uuid())
  taskId     String   @map("task_id")
  uploadedBy String   @map("uploaded_by")
  s3Key      String   @map("s3_key")
  fileName   String   @map("file_name")
  mimeType   String   @map("mime_type")
  sizeBytes  Int      @map("size_bytes")
  createdAt  DateTime @default(now()) @map("created_at")
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader   User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_attachments")
}

model GitHubSyncLog {
  id                String   @id @default(uuid())
  taskId            String?  @map("task_id")
  projectId         String   @map("project_id")
  action            String
  status            String
  errorMessage      String?  @map("error_message")
  githubIssueNumber Int?     @map("github_issue_number")
  userId            String   @map("user_id")
  createdAt         DateTime @default(now()) @map("created_at")
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task              Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt(sort: Desc)])
  @@index([taskId])
  @@index([userId])
  @@map("github_sync_logs")
}

enum UserRole {
  admin
  member
}

enum SprintStatus {
  planned
  active
  completed
}

enum TaskStatus {
  todo
  progress
  review
  done
}

enum TaskPriority {
  low
  medium
  high
  critical
}

enum TaskType {
  story
  task
  bug
}
